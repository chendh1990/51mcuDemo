A51 MACRO ASSEMBLER  OS_CPU_A                                                             11/07/2015 14:53:11 PAGE     1


MACRO ASSEMBLER A51 V8.01
OBJECT MODULE PLACED IN ..\out\obj\OS_CPU_A.obj
ASSEMBLER INVOKED BY: C:\Program Files\Keil\C51\BIN\A51.EXE ..\OS_CPU\OS_CPU_A.ASM INCDIR(..\OS) SET(LARGE) DEBUG PRINT(
                      ..\out\list\OS_CPU_A.lst) OBJECT(..\out\obj\OS_CPU_A.obj) EP

LOC  OBJ            LINE     SOURCE

                       1     ;******************************************************************************************
                             ***************
                       2     ;**                                                            Small RTOS 51 
                       3     ;**                                   The Real-Time Kernel For Keil c51
                       4     ;**
                       5     ;**                                  (c) Copyright 2002-2003, chenmingji
                       6     ;**                                           All Rights Reserved
                       7     ;**
                       8     ;**                                                  V1.12.1
                       9     ;**
                      10     ;**
                      11     ;**--------------------ÎÄ¼þÐÅÏ¢------------------------------------------------------------
                             ---------------
                      12     ;**ÎÄ   ¼þ   Ãû: OS_CPU_A.ASM
                      13     ;**´´   ½¨   ÈË: ³ÂÃ÷¼Æ
                      14     ;**°æ        ±¾: V1.12.1
                      15     ;**×îºóÐÞ¸ÄÈÕÆÚ:  2002Äê2ÔÂ5ÈÕ
                      16     ;**Ãè¡¡      Êö:  Small RTOS 51 ÓëCPU(8051ÏµÁÐ)Ïà¹ØµÄ»ã±à³ÌÐò
                      17     ;**---------------------ÀúÊ·°æ±¾ÐÅÏ¢-------------------------------------------------------
                             ---------------
                      18     ;** ´´½¨ÈË: ³ÂÃ÷¼Æ
                      19     ;** °æ  ±¾:V0.50
                      20     ;** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ22ÈÕ
                      21     ;** Ãè¡¡Êö: Ô­Ê¼°æ±¾
                      22     ;**
                      23     ;**----------------------------------------------------------------------------------------
                             --------------
                      24     ;** ÐÞ¸ÄÈË: ³ÂÃ÷¼Æ
                      25     ;** °æ  ±¾: V1.00
                      26     ;** ÈÕ¡¡ÆÚ: 2002Äê6ÔÂ10ÈÕ
                      27     ;** Ãè¡¡Êö: Ö§³ÖÈíµÄ·ÇÆÁ±ÎÖÐ¶Ï
                      28     ;**
                      29     ;**----------------------------------------------------------------------------------------
                             --------------
                      30     ;** ÐÞ¸ÄÈË: ³ÂÃ÷¼Æ
                      31     ;** °æ  ±¾: V1.10.3
                      32     ;** ÈÕ¡¡ÆÚ: 2002Äê9ÔÂ16ÈÕ
                      33     ;** Ãè¡¡Êö: ÐÞ¸ÄÁËLoadCtx´úÂëÊ¹Ö®Ö´ÐÐ¸ü¿ì£¬´úÂë¸üÐ¡
                      34     ;**         
                      35     ;**----------------------------------------------------------------------------------------
                             --------------
                      36     ;** ÐÞ¸ÄÈË: ³ÂÃ÷¼Æ
                      37     ;** °æ  ±¾: V1.10.4
                      38     ;** ÈÕ¡¡ÆÚ: 2002Äê10ÔÂ5ÈÕ
                      39     ;** Ãè¡¡Êö: ½«OS_CPU_A.ASMºÍOS_CPU_A_task16.ASMºÏ²¢
                      40     ;**
                      41     ;**----------------------------------------------------------------------------------------
                             --------------
                      42     ;** ÐÞ¸ÄÈË: ³ÂÃ÷¼Æ
                      43     ;** °æ  ±¾: V1.11.0
                      44     ;** ÈÕ¡¡ÆÚ: 2002Äê12ÔÂ2ÈÕ
                      45     ;** Ãè¡¡Êö: ¸ù¾ÝÐÂ°æ±¾ÒªÇóÊ¹ÈÎÎñ¶ÑÕ»°üº¬Os_Enter_Sum£¬Ê¹ÓÅÏÈ¼¶×îµÍ
                      46     ;**         µÄÈÎÎñÖ»±£´æÉÙÁ¿¼Ä´æÆ÷£»Ôö¼Ó×¢ÊÍ
                      47     ;**----------------------------------------------------------------------------------------
                             --------------
                      48     ;** ÐÞ¸ÄÈË: ³ÂÃ÷¼Æ
                      49     ;** °æ  ±¾: V1.12.0
A51 MACRO ASSEMBLER  OS_CPU_A                                                             11/07/2015 14:53:11 PAGE     2

                      50     ;** ÈÕ¡¡ÆÚ: 2002Äê12ÔÂ30ÈÕ
                      51     ;** Ãè¡¡Êö: ¸ù¾ÝÐÂ°æ±¾ÒªÇó¸ü¸ÄÉÙÁ¿´úÂë
                      52     ;**----------------------------------------------------------------------------------------
                             --------------
                      53     ;** ÐÞ¸ÄÈË: ³ÂÃ÷¼Æ
                      54     ;** °æ  ±¾: V1.12.1
                      55     ;** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ5ÈÕ
                      56     ;** Ãè¡¡Êö: ¸üÕLoadCtxÖÐOS_MAX_TASKSÎª8»ò16µÄbug
                      57     ;**---------------------µ±Ç°°æ±¾ÐÞ¶©-------------------------------------------------------
                             ----------------
                      58     ;** ÐÞ¸ÄÈË:
                      59     ;** ÈÕ¡¡ÆÚ:
                      60     ;** Ãè¡¡Êö:
                      61     ;**
                      62     ;**----------------------------------------------------------------------------------------
                             --------------
                      63     ;******************************************************************************************
                             **************/
                      64     ;#include "OS_CPU.H"
                +1    65     
                +1    66     
                +1    67     
                +1    68     
                +1    69     
                +1    70     
                +1    71     
                +1    72     
                +1    73     
                +1    74     
                +1    75     
                +1    76     
                +1    77     
                +1    78     
                +1    79     
                +1    80     
                +1    81     
                +1    82     
                +1    83     
                +1    84     
                +1    85     
                +1    86     
                +1    87     
                +1    88     
                +1    89     
                +1    90     
                +1    91     
                +1    92     
                +1    93     
                +1    94     
                +1    95     
                +1    96     
                +1    97     
                +1    98     
                +1    99     
                +1   100     
                +1   101     
                +1   102     
                +1   103     
                +1   104     
                +1   105     
                +1   106     
                +1   107     
                +1   108     
                +1   109     
                +1   110     
                +1   111     
A51 MACRO ASSEMBLER  OS_CPU_A                                                             11/07/2015 14:53:11 PAGE     3

                +1   112     
                +1   113     
                +1   114     
                +1   115     
                +1   116     
                +1   117     
                +1   118     
                +1   119     
                +1   120     
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1   160     
                +1   161     
                +1   162     
                +1   163     
                +1   164     
                +1   165     SET_EA   MACRO                                 ;´ò¿ªËùÓÐÔÊÐíÖÐ¶Ï
                +1   166                  SETB     EA
                +1   167              ENDM
                +1   168              
                +1   169     
                     170     
                     171     ;#include "OS_CFG.H"
                +1   172     
                +1   173     
                +1   174     
                +1   175     
                +1   176     
                +1   177     
A51 MACRO ASSEMBLER  OS_CPU_A                                                             11/07/2015 14:53:11 PAGE     4

                +1   178     
                +1   179     
                +1   180     
                +1   181     
                +1   182     
                +1   183     
                +1   184     
                +1   185     
                +1   186     
                +1   187     
                +1   188     
                +1   189     
                +1   190     
                +1   191     
                +1   192     
                +1   193     
                +1   194     
                +1   195     
                +1   196     
                +1   197     
                +1   198     
                +1   199     
                +1   200     
                +1   201     
                +1   202     
                +1   203     
                +1   204     
                +1   205     
                +1   206     
                +1   207     
                +1   208     
                +1   209     
                +1   210     
                +1   211     
                +1   212     
                +1   213     
                +1   214     
                +1   215     
                +1   216     
                +1   217     
                +1   218     
                +1   219     
                +1   220     
                +1   221     
                +1   222     
                +1   223     
                +1   224     
                +1   225     
                +1   226                                                 
                +1   227     
                +1   228     
                +1   229     
                +1   230     
                +1   231     
                +1   232     
                +1   233     
                +1   234     
                +1   235     
                +1   236     
                +1   237     
                +1   238     
                +1   239     
                +1   240                                                 
                +1   241     
                +1   242     
                +1   243     
A51 MACRO ASSEMBLER  OS_CPU_A                                                             11/07/2015 14:53:11 PAGE     5

                +1   244     
                +1   245     
                +1   246     
                +1   247     
                +1   248     
                +1   249     
                +1   250     
                +1   251     
                +1           
                +1           
                +1   254     
                +1   255     
                +1           
                +1           
                +1           
                +1           
                +1           
                     261     
                     262     
                     263             NAME    OS_CPU_A_ASM
                     264     
                     265     ?PR?OSCtxSw?OS_CPU_A                     SEGMENT CODE ;INBLOCK 
                     266     ?PR?OSIntCtxSw?OS_CPU_A                  SEGMENT CODE ;INBLOCK 
                     267     ?PR?LoadCtx?OS_CPU_A                     SEGMENT CODE ;INBLOCK 
                     268     ?PR?C_OSCtxSw?OS_CPU_C                   SEGMENT CODE 
                     269     
                     270     
                     271             EXTRN   CODE (OSMapTbl)
                     272             EXTRN   DATA (OSFastSwap)
                     273             EXTRN   DATA (OSTaskID)
                     274             EXTRN   DATA (OSNextTaskID)
                     275             EXTRN   DATA (OSTsakStackBotton)
                     276             EXTRN   DATA (Os_Enter_Sum)
                     277     IF 0  <> 0
                                     EXTRN   IDATA (Sp2)
                             ENDIF
                     280     
                     281     
                     282             PUBLIC  LoadCtx
                     283             PUBLIC  OSIntCtxSw
                     284             PUBLIC  OSCtxSw
                     285             PUBLIC  STACK 
                     286     
                     287     ;****************************************************************************************
                     288     ;?STACK SEGMENT IDATA
                     289     
                     290     ?STACK          SEGMENT   IDATA
                     291     
----                 292                     RSEG    ?STACK
0000                 293     STACK:                                          ;¶ÑÕ»
0000                 294                     DS      1
                     295     
                     296     ;****************************************************************************************
                     297     ;/*****************************************************************************************
                             ****************
                     298     ;** º¯ÊÃû³Æ: LoadCtx
                     299     ;** ¹¦ÄÜÃèÊö: ÈÎÎñ»·¾³»Ö¸´º¯Ê
                     300     ;** Êä¡¡Èë: OSTaskID,OSFastSwap
                     301     ;** Êä¡¡³ö : ÎÞ
                     302     ;** È«¾Ö±äÁ¿: ÎÞ
                     303     ;** µ÷ÓÃÄ£¿é: ÎÞ
                     304     ;** 
                     305     ;** ×÷¡¡Õß: ³ÂÃ÷¼Æ
                     306     ;** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ22ÈÕ
                     307     ;**----------------------------------------------------------------------------------------
                             ---------------
A51 MACRO ASSEMBLER  OS_CPU_A                                                             11/07/2015 14:53:11 PAGE     6

                     308     ;** ÐÞ¡¡¸Ä: ³ÂÃ÷¼Æ
                     309     ;** ÈÕ¡¡ÆÚ: 2002Äê12ÔÂ2ÈÕ
                     310     ;**----------------------------------------------------------------------------------------
                             ---------------
                     311     ;** ÐÞ¡¡¸Ä: ³ÂÃ÷¼Æ
                     312     ;** ÈÕ¡¡ÆÚ: 2003Äê2ÔÂ5ÈÕ
                     313     ;**----------------------------------------------------------------------------------------
                             ---------------
                     314     ;** ÐÞ¡¡¸Ä:
                     315     ;** ÈÕ¡¡ÆÚ:
                     316     ;**----------------------------------------------------------------------------------------
                             ---------------
                     317     ;******************************************************************************************
                             **************/
                     318     
----                 319             RSEG  ?PR?LoadCtx?OS_CPU_A
0000                 320     LoadCtx:
                     321             USING   0
                     322                
0000 D000     F      323         POP     Os_Enter_Sum            ;»Ö¸´¹ØÖÐ¶Ï¼ÆÊÆ÷
                     324                                         ;ÅÐ¶ÏÊÇ·ñÐèÒª»Ö¸´ËùÓÐ¼Ä´æÆ÷
0002 E500     F      325         MOV     A,OSTaskID
0004 B40502          326         CJNE    A,#5,LoadCtx_0
0007 8022            327         SJMP    LoadCtx_2
0009                 328     LoadCtx_0:
0009 900000   F      329         MOV     DPTR,#OSMapTbl
                     330     
000C 93              331         MOVC    A,@A+DPTR
000D 5500     F      332         ANL     A,OSFastSwap
                             
                                 
                                 
                                 
                                 
                                 
                                 
                             
                                 
                                 
                             
000F 701A            344         JNZ     LoadCtx_2
                     345                                         ;»Ö¸´¼Ä´æÆ÷
0011 D007            346         POP     7
0013 D006            347         POP     6
0015 D005            348         POP     5
0017 D004            349         POP     4
0019 D003            350         POP     3
001B D002            351         POP     2
001D D001            352         POP     1
001F D000            353         POP     0
0021 D0D0            354         POP     PSW
0023 D082            355         POP     DPL
0025 D083            356         POP     DPH
0027 D0F0            357         POP     B
0029 D0E0            358         POP     ACC
002B                 359     LoadCtx_2:
                     360                                         ;ÅÐ¶ÏÊÇ·ñÐèÒª¿ªÖÐ¶Ï
002B 0500     F      361         INC     Os_Enter_Sum
002D D50002   F      362         djnz    Os_Enter_Sum,LoadCtx_3
                     363         SET_EA                          ;¿ªÖÐ¶Ï
0032                 365     LoadCtx_3:
0032 22              366         RET
                     367     
                     368     ;****************************************************************************************
                     369     ;/*****************************************************************************************
                             ****************
A51 MACRO ASSEMBLER  OS_CPU_A                                                             11/07/2015 14:53:11 PAGE     7

                     370     ;** º¯ÊÃû³Æ: OSCtxSw
                     371     ;** ¹¦ÄÜÃèÊö: ÈÎÎñÖ÷¶¯·ÅÆúCPU»·¾³±£´æº¯Ê
                     372     ;** Êä¡¡Èë: OSTaskID
                     373     ;** Êä¡¡³ö : ÎÞ
                     374     ;** È«¾Ö±äÁ¿: OSFastSwap
                     375     ;** µ÷ÓÃÄ£¿é: ÎÞ
                     376     ;** 
                     377     ;** ×÷¡¡Õß: ³ÂÃ÷¼Æ
                     378     ;** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ22ÈÕ
                     379     ;**----------------------------------------------------------------------------------------
                             ---------------
                     380     ;** ÐÞ¡¡¸Ä:
                     381     ;** ÈÕ¡¡ÆÚ:
                     382     ;**----------------------------------------------------------------------------------------
                             ---------------
                     383     ;******************************************************************************************
                             **************/
----                 384         RSEG  ?PR?OSCtxSw?OS_CPU_A
0000                 385     OSCtxSw:
                     386         USING       0
                     387                                         ;ÉèÖÃ±êÖ¾£ºÈÎÎñÔÙ´Î»Ö¸´ÔËÐÐÊ±²»±Ø»Ö¸´ËùÓÐ¼Ä´æÆ÷
0000 900000   F      388         MOV     DPTR,#OSMapTbl
0003 E500     F      389         MOV     A,OSTaskID
                     390     
0005 93              391         MOVC    A,@A+DPTR
0006 4500     F      392         ORL     A,OSFastSwap
0008 F500     F      393         MOV     OSFastSwap,A
                             
                                 
                                 
                                 
                                 
                                 
                                 
                                 
                             
                                 
                                 
                                 
                                 
                             
000A 020000   F      408         LJMP    C_OSCtxSw
                     409     ;****************************************************************************************
                     410     ;/*****************************************************************************************
                             ****************
                     411     ;** º¯ÊÃû³Æ: C_OSCtxSw
                     412     ;** ¹¦ÄÜÃèÊö: ¶ÑÕ»´¦Àíº¯Ê
                     413     ;** Êä¡¡Èë: ÎÞ
                     414     ;** Êä¡¡³ö : ÎÞ
                     415     ;** È«¾Ö±äÁ¿: OSTaskID,OSTsakStackBotton,SP
                     416     ;** µ÷ÓÃÄ£¿é: LoadCtx
                     417     ;** 
                     418     ;** ×÷¡¡Õß: ³ÂÃ÷¼Æ
                     419     ;** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ22ÈÕ
                     420     ;**----------------------------------------------------------------------------------------
                             ---------------
                     421     ;** ÐÞ¡¡¸Ä: ³ÂÃ÷¼Æ
                     422     ;** ÈÕ¡¡ÆÚ: 2002Äê12ÔÂ2ÈÕ
                     423     ;**----------------------------------------------------------------------------------------
                             ---------------
                     424     ;** ÐÞ¡¡¸Ä:
                     425     ;** ÈÕ¡¡ÆÚ:
                     426     ;**----------------------------------------------------------------------------------------
                             ---------------
                     427     ;******************************************************************************************
                             **************/
A51 MACRO ASSEMBLER  OS_CPU_A                                                             11/07/2015 14:53:11 PAGE     8

----                 428             RSEG  ?PR?C_OSCtxSw?OS_CPU_C
0000                 429     C_OSCtxSw:
0000 C000     F      430         PUSH    Os_Enter_Sum            ;±£´æ¹ØÖÐ¶Ï¼ÆÊÆ÷
0002 AA81            431         mov     r2,sp
                     432         
                     433     ;     cp1 = (unsigned char idata *)SP +1;
0004 A881            434         MOV     R0,SP
                     435     
                     436     IF 0  <> 0
                                 mov     sp,#(Sp2-1)             ;¶ÑÕ»Ö¸ÏòÁÙÊ±¿Õ¼ä£¬ÔÊÐí¡°Èí·ÇÆÁ±ÎÖÐ¶Ï¡±
                             ENDIF
                     439     
0006 08              440         INC     R0
                     441     ;     temp = (unsigned char )OSTsakStackBotton[OSNextTaskID+1];
0007 7400     F      442         MOV     A,#LOW (OSTsakStackBotton+01H)
0009 2500     F      443         ADD     A,OSNextTaskID
000B F9              444         MOV     R1,A
000C E7              445         MOV     A,@R1
000D FF              446         MOV     R7,A
                     447     ;     cp2 = OSTsakStackBotton[OSTaskID+1];
000E 7400     F      448         MOV     A,#LOW (OSTsakStackBotton+01H)
0010 2500     F      449         ADD     A,OSTaskID
0012 F9              450         MOV     R1,A
0013 E7              451         MOV     A,@R1
0014 F9              452         MOV     R1,A
                     453     ;     if( OSNextTaskID > OSTaskID)
0015 E500     F      454         MOV     A,OSNextTaskID
0017 D3              455         SETB    C
0018 9500     F      456         SUBB    A,OSTaskID
001A 4033            457         JC      ?C0001
                     458     ;     {
                     459     ;         while(cp2 != (unsigned char idata *)temp)
                     460     ;         {
                     461     ;             *cp1++ = *cp2++;
                     462     ;         }
001C EF              463         MOV     A,R7
001D C3              464         CLR     C
001E 99              465         SUBB    A,R1
001F FE              466         MOV     R6,A
0020                 467     ?C0002:
0020 E7              468         MOV     A,@R1
0021 F6              469         MOV     @R0,A
0022 08              470         INC     R0
0023 09              471         INC     R1
0024 DEFA            472         DJNZ    R6,?C0002
0026                 473     ?C0003:
                     474     ;         temp = OSTsakStackBotton[OSTaskID+1] - (unsigned char idata *)SP-1;
0026 7400     F      475         MOV     A,#LOW (OSTsakStackBotton+1)
0028 2500     F      476         ADD     A,OSTaskID
002A F9              477         MOV     R1,A
002B E7              478         MOV     A,@R1
002C D3              479         SETB    C
                     480         ;SUBB    A,sp
002D 9A              481         SUBB    A,r2
002E FF              482         MOV     R7,A
                     483     ;         SP = (unsigned char )cp1 - 1;
002F 18              484         DEC     R0;
0030 8881            485         MOV     SP,R0
                     486     ;         for(i = OSTaskID+1;i < OSNextTaskID+1; i++)
                     487     ;         {
                     488     ;             OSTsakStackBotton[i] -= temp;
                     489     ;         }
0032 E500     F      490         MOV     A,OSNextTaskID
0034 C3              491         CLR     C
0035 9500     F      492         SUBB    A,OSTaskID
0037 FE              493         MOV     R6,A
A51 MACRO ASSEMBLER  OS_CPU_A                                                             11/07/2015 14:53:11 PAGE     9

0038 600F            494         JZ      ?C0005
                     495     
003A 7400     F      496         MOV     A,#LOW (OSTsakStackBotton)
003C 2500     F      497         ADD     A,OSTaskID
003E F9              498         MOV     R1,A    
003F EF              499         MOV     A,R7
0040 F4              500         CPL     A
0041 04              501         INC     A
0042 FF              502         MOV     R7,A
0043                 503     ?C0004:
0043 09              504         INC     R1
0044 EF              505         MOV     A,R7
0045 27              506         ADD     A,@R1    
0046 F7              507         MOV     @R1,A
0047 DEFA            508         DJNZ    R6,?C0004
0049                 509     ?C0005:
                     510     ;         OSTaskID = OSNextTaskID;
0049 850000   F      511         MOV     OSTaskID,OSNextTaskID
                     512     ;         LoadCtx();    
004C 020000   F      513         LJMP    LoadCtx
                     514     ;     }
004F                 515     ?C0001:
                     516     ; 
                     517     ;     if( OSNextTaskID != OSTaskID)
004F E500     F      518         MOV     A,OSNextTaskID
0051 6500     F      519         XRL     A,OSTaskID
0053 6036            520         JZ      ?C000r
                     521     ;     {
                     522     ;          cp2--;
                     523     ;          cp1--;
                     524     ;         while(cp2 != (unsigned char idata *)temp)
                     525     ;         {
                     526     ;             *cp2-- = *cp1--;
                     527     ;         }
                     528         ;MOV     A,R7
                     529         ;CLR     C
                     530         ;SUBB    A,R1
                     531         ;MOV     R6,A
0055 E8              532         mov     a,r0
0056 C3              533         clr     c
0057 9F              534         subb    a,r7
0058 FE              535         mov     r6,a
0059                 536     ?C0008:
0059 18              537         DEC     R0
005A 19              538         DEC     R1
005B E6              539         MOV     A,@R0
005C F7              540         MOV     @R1,A
005D DEFA            541         DJNZ    R6,?C0008
005F                 542     ?C0009:
                     543     ;         temp = OSTsakStackBotton[OSTaskID+1] - (unsigned char idata *)SP-1;
005F 7400     F      544         MOV     A,#LOW (OSTsakStackBotton+01H)
0061 2500     F      545         ADD     A,OSTaskID
0063 F9              546         MOV     R1,A
0064 E7              547         MOV     A,@R1
0065 D3              548         SETB    C
                     549         ;SUBB    A,SP
0066 9A              550         SUBB    A,r2
0067 FF              551         MOV     R7,A
                     552     ;         SP = (unsigned char )OSTsakStackBotton[OSNextTaskID+1];
0068 7400     F      553         MOV     A,#LOW (OSTsakStackBotton+01H)
006A 2500     F      554         ADD     A,OSNextTaskID
006C F9              555         MOV     R1,A
006D E7              556         MOV     A,@R1
006E F581            557         MOV     SP,A
                     558     ;         for(i = OSNextTaskID+1;i < OSTaskID+1; i++)
                     559     ;         {
A51 MACRO ASSEMBLER  OS_CPU_A                                                             11/07/2015 14:53:11 PAGE    10

                     560     ;             OSTsakStackBotton[i] += temp;
                     561     ;         }
                     562     
0070 E500     F      563         MOV     A,OSTaskID
0072 C3              564         CLR     C
0073 9500     F      565         SUBB    A,OSNextTaskID
0075 600C            566         JZ      ?C0011
                     567     
0077 FE              568         MOV     R6,A
0078 7400     F      569         MOV     A,#LOW (OSTsakStackBotton)
007A 2500     F      570         ADD     A,OSNextTaskID
007C F9              571         MOV     R1,A    
007D                 572     ?C0010:
007D 09              573         INC     R1
007E EF              574         MOV     A,R7
007F 27              575         ADD     A,@R1    
0080 F7              576         MOV     @R1,A
0081 DEFA            577         DJNZ    R6,?C0010
                     578     
0083                 579     ?C0011:
                     580     ;         OSTaskID = OSNextTaskID;        
0083 850000   F      581         MOV         OSTaskID,OSNextTaskID
                     582     ;         SP--;
0086 1581            583         DEC         SP
                     584     ;     }
0088                 585     ?C0007:
                     586     ;     LoadCtx();
0088 020000   F      587         LJMP        LoadCtx
008B                 588     ?C000r:
                     589     IF 0  <> 0
                                 mov     SP,r2
                             ENDIF
008B 020000   F      592         LJMP        LoadCtx
                     593     ;****************************************************************************************
                     594     ;/*****************************************************************************************
                             ****************
                     595     ;** º¯ÊÃû³Æ: OSIntCtxSw
                     596     ;** ¹¦ÄÜÃèÊö: ÖÐ¶ÏÊ¹ÈÎÎñ·ÅÆúCPU»·¾³±£´æº¯Ê
                     597     ;** Êä¡¡Èë: OSTaskID
                     598     ;** Êä¡¡³ö : ÎÞ
                     599     ;** È«¾Ö±äÁ¿: OSFastSwap
                     600     ;** µ÷ÓÃÄ£¿é: ÎÞ
                     601     ;** 
                     602     ;** ×÷¡¡Õß: ³ÂÃ÷¼Æ
                     603     ;** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ22ÈÕ
                     604     ;**----------------------------------------------------------------------------------------
                             ---------------
                     605     ;** ÐÞ¡¡¸Ä: ³ÂÃ÷¼Æ
                     606     ;** ÈÕ¡¡ÆÚ: 2002Äê12ÔÂ2ÈÕ
                     607     ;**----------------------------------------------------------------------------------------
                             ---------------
                     608     ;** ÐÞ¡¡¸Ä:
                     609     ;** ÈÕ¡¡ÆÚ:
                     610     ;**----------------------------------------------------------------------------------------
                             ---------------
                     611     ;******************************************************************************************
                             **************/
----                 612             RSEG  ?PR?OSIntCtxSw?OS_CPU_A
0000                 613     OSIntCtxSw:
                     614             USING   0
                     615                                             ;ÊÇ·ñÊÇÓÅÏÈ¼¶×îµÍÈÎÎñ
0000 7405            616         MOV     A,#5
0002 6500     F      617         XRL     A,OSTaskID
0004 700F            618         JNZ     OSIntCtxSw_0
                     619                                             ;ÊÇÔò²»ÐèÒª±£´æËùÓÐ¼Ä´æÆ÷
                     620     ;SP=SP-13-4                             ;4:Á½²ãº¯Êµ÷ÓÃ¶ÑÕ»£¬13£º¼Ä´æÆ÷ÊÄ¿
A51 MACRO ASSEMBLER  OS_CPU_A                                                             11/07/2015 14:53:11 PAGE    11

0006 74EF            621         MOV     A,#(-17)
0008 2581            622         ADD     A,SP
000A F581            623         MOV     SP,A
                     624                                             ;Ìø×ªµ½OSCtxSw£¬Í¬Ê±Í¨ÖªCPUÖÐ¶Ï´¦ÀíÍê³É
000C 7400     F      625         MOV     A, #LOW  OSCtxSw
000E C0E0            626         PUSH    ACC
0010 7400     F      627         MOV     A, #HIGH OSCtxSw
0012 C0E0            628         PUSH    ACC
0014 32              629         RETI
                     630                                             ;ÐèÒª±£´æËùÓÐ¼Ä´æÆ÷
0015                 631     OSIntCtxSw_0:
                     632     ;SP=SP-4                                ;4:Á½²ãº¯Êµ÷ÓÃ¶ÑÕ»
0015 74FC            633         MOV     A,#0FCH
0017 2581            634         ADD     A,SP
0019 F581            635         MOV     SP,A
                     636                                             ;ÉèÖÃ±êÖ¾£ºÈÎÎñÔÙ´Î»Ö¸´ÔËÐÐÊ±ÐèÒª»Ö¸´ËùÓÐ¼Ä´æÆ÷
001B 900000   F      637         MOV     DPTR,#OSMapTbl
001E E500     F      638         MOV     A,OSTaskID
                     639     
0020 93              640         MOVC    A,@A+DPTR
0021 F4              641         CPL     A
0022 5500     F      642         ANL     A,OSFastSwap
0024 F500     F      643         MOV     OSFastSwap,A    
                             
                                 
                                 
                                 
                                 
                                 
                                 
                                 
                                 
                             
                                 
                                 
                                 
                                 
                                 
                             
                             
                     661                                             ;Ìø×ªµ½¶ÑÕ»´¦Àí£¬Í¬Ê±Í¨ÖªCPUÖÐ¶Ï´¦ÀíÍê³É
0026 7400     F      662         MOV     A, #LOW  C_OSCtxSw
0028 C0E0            663         PUSH    ACC
002A 7400     F      664         MOV     A, #HIGH C_OSCtxSw
002C C0E0            665         PUSH    ACC
002E 32              666         RETI
                     667     
                     668     ;****************************************************************************************
                     669             END
A51 MACRO ASSEMBLER  OS_CPU_A                                                             11/07/2015 14:53:11 PAGE    12

SYMBOL TABLE LISTING
------ ----- -------


N A M E                  T Y P E  V A L U E   ATTRIBUTES

?C0001. . . . . . . . .  C ADDR   004FH   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C0002. . . . . . . . .  C ADDR   0020H   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C0003. . . . . . . . .  C ADDR   0026H   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C0004. . . . . . . . .  C ADDR   0043H   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C0005. . . . . . . . .  C ADDR   0049H   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C0007. . . . . . . . .  C ADDR   0088H   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C0008. . . . . . . . .  C ADDR   0059H   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C0009. . . . . . . . .  C ADDR   005FH   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C000R. . . . . . . . .  C ADDR   008BH   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C0010. . . . . . . . .  C ADDR   007DH   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C0011. . . . . . . . .  C ADDR   0083H   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?PR?C_OSCTXSW?OS_CPU_C.  C SEG    008EH       REL=UNIT
?PR?LOADCTX?OS_CPU_A. .  C SEG    0033H       REL=UNIT
?PR?OSCTXSW?OS_CPU_A. .  C SEG    000DH       REL=UNIT
?PR?OSINTCTXSW?OS_CPU_A  C SEG    002FH       REL=UNIT
?STACK. . . . . . . . .  I SEG    0001H       REL=UNIT
ACC . . . . . . . . . .  D ADDR   00E0H   A   
B . . . . . . . . . . .  D ADDR   00F0H   A   
C_OSCTXSW . . . . . . .  C ADDR   0000H   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
DPH . . . . . . . . . .  D ADDR   0083H   A   
DPL . . . . . . . . . .  D ADDR   0082H   A   
EA. . . . . . . . . . .  B ADDR   00A8H.7 A   
LOADCTX . . . . . . . .  C ADDR   0000H   R   SEG=?PR?LOADCTX?OS_CPU_A
LOADCTX_0 . . . . . . .  C ADDR   0009H   R   SEG=?PR?LOADCTX?OS_CPU_A
LOADCTX_2 . . . . . . .  C ADDR   002BH   R   SEG=?PR?LOADCTX?OS_CPU_A
LOADCTX_3 . . . . . . .  C ADDR   0032H   R   SEG=?PR?LOADCTX?OS_CPU_A
OSCTXSW . . . . . . . .  C ADDR   0000H   R   SEG=?PR?OSCTXSW?OS_CPU_A
OSFASTSWAP. . . . . . .  D ADDR   -----       EXT
OSINTCTXSW. . . . . . .  C ADDR   0000H   R   SEG=?PR?OSINTCTXSW?OS_CPU_A
OSINTCTXSW_0. . . . . .  C ADDR   0015H   R   SEG=?PR?OSINTCTXSW?OS_CPU_A
OSMAPTBL. . . . . . . .  C ADDR   -----       EXT
OSNEXTTASKID. . . . . .  D ADDR   -----       EXT
OSTASKID. . . . . . . .  D ADDR   -----       EXT
OSTSAKSTACKBOTTON . . .  D ADDR   -----       EXT
OS_CPU_A_ASM. . . . . .  N NUMB   -----       
OS_ENTER_SUM. . . . . .  D ADDR   -----       EXT
PSW . . . . . . . . . .  D ADDR   00D0H   A   
SP. . . . . . . . . . .  D ADDR   0081H   A   
STACK . . . . . . . . .  I ADDR   0000H   R   SEG=?STACK


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
